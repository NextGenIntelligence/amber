;
; rowl - generation 1
; Copyright (C) 2010 nineties
;
; $Id: vm-eval.rlc 2010-06-04 02:38:23 nineties $
;

(var instructions `(
    (fin ((return)))
    ))

(var insn_entries ())
(do
    (var idx 0)
    (foreach e instructions (do
        (set insn_entries (cons `(@idx @(cadr e)) insn_entries))
        (incl idx)
        ))
    (set insn_entries (reverse insn_entries))
)


(var vm-eval-code `(

(int* sp)          ; stack pointer
(int stack_size)    ; in words
(int* stack)

(fun vm_init (stsize) (
    (+= stsize @BLOCK_SIZE)
    (&= stsize @BLOCK_MASK)
    (= stack (alloc_block stsize))
    (= stack_size stsize)
    (= sp stack)
    ))

(fun vm_eval (insns) (
    (byte code (fetch insns))
    (tswitch code @insn_entries)
    ))

))
