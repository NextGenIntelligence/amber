;
; rowl - generation 1
; Copyright (C) 2010 nineties
;
; $Id: vm-eval.rlc 2010-06-04 11:17:12 nineties $
;

(var instructions `(
    (fin        ((return)))
    (imm_i0     ((vm_push 0)))
    ))

(var insn_entries ())
(do
    (var idx 0)
    (foreach e instructions (do
        (set insn_entries (cons `(@idx @(cadr e)) insn_entries))
        (incl idx)
        ))
    (set insn_entries (reverse insn_entries))
)

(define emit_vm_push ((_ val) _ _) (do
    (emit_expr val `%eax nil)
    (emit "subl" 4 (lookup_var sp))
    (movl `%eax (lookup_var sp))
    ))

(add_new_expr `vm_push emit_vm_push)

(var vm-eval-code `(

(int* sp)          ; stack pointer
(int stack_size)   ; in words
(int* stack)

(fun vm_init (stsize) (
    (+= stsize @BLOCK_SIZE)
    (&= stsize @BLOCK_MASK)
    (= stack (alloc_block stsize))
    (= stack_size stsize)
    (= sp (+ stack (* 4 stack_size)))
    ))

(fun vm_eval (pc) (
    (byte code (load8 pc))
    (tswitch code @insn_entries)
    ))

))
