;
; rowl - generation 1
; Copyright (C) 2010 nineties
;
; $Id: vm-eval.rlc 2010-06-08 19:27:04 nineties $
;

; rowlVM register usage
;   %eax, %ecx : general purpose register
;   %ebx       : program counter
;   %esi       : stack pointer

(import "vm-insn")

(var insn_entries ())
(do
    (foreach e vm_instructions (do
        (var label (mklabel (car e)))
        (var len (cadr e))
        (var code (cadddr e))
        (if (caddr e) (set code (append code `((vmsucc @len) (vmfetch)))))
        (set insn_entries (cons `(@label @code) insn_entries))
        ))
    (set insn_entries (reverse insn_entries))
)

(define emit_vmemit ((_ inst . opds) _ _) (do
    (print '\t')
    (print inst)
    (print ' ')
    (foreach o opds (do
        (if (== o `%tos) (set o "(%esi)"))
        (print o)
        (if (not last?) (print ", "))
        ))
    (print '\n')
    ))

(define emit_vmpush ((_ val) _ _) (do
    (emit "subl" 4 `%esi)
    (movl val `(deref %esi 0))
    ))

(define emit_vmpop ((_ reg) _ _) (do
    (movl `(deref %esi 0) reg)
    (emit "addl" 4 `%esi)
    ))

(define emit_vmsucc ((_ len) _ _) (do
    (emit "addl" len `%ebx)
    ))

(define emit_vmfetch ((_) _ _) (do
    (emit "movzbl" `(deref %ebx 0) `%eax)
    (movl `(offset %eax insn_table 4) `%eax)
    (emit "jmp" `*%eax)
    ))

(define emit_vmubyte ((_ offs reg) _ _) (do
    (emit "movzbl" `(deref %ebx @offs) reg)
    ))

(define emit_vmsbyte ((_ offs reg) _ _) (do
    (emit "movsx" `(deref %ebx @offs) reg)
    ))

; switch implementation using table jump
(define emit_vmtable ((_ tblname body) _ ret) (do
    ; table area
    (change_area `rodata)
    (emit ".align 4")
    (emit ".align 4")
    (print_label tblname)
    (foreach case body (emit ".long" (car case)))

    ; code area
    (push_break_point)
    (change_area `text)
    (foreach case body (do
        (print_label (car case))
        (emit_block (cadr case) nil)
        ))
    (emit_break_point)
    (pop_break_point)

    (if ret (emit_return `(return) nil nil))
    ))

(define emit_vmbin ((_ asmcode) _ ret) (do
    (emit_expr `(vmpop %eax) nil nil)
    (emit_expr `(asm @asmcode " %eax, (%esi)") nil ret)
    ))

(add_new_expr `vmemit   emit_vmemit)
(add_new_expr `vmpush   emit_vmpush)
(add_new_expr `vmpop    emit_vmpop)
(add_new_expr `vmsucc   emit_vmsucc)
(add_new_expr `vmfetch  emit_vmfetch)
(add_new_expr `vmubyte  emit_vmubyte)
(add_new_expr `vmsbyte  emit_vmsbyte)
(add_new_expr `vmtable  emit_vmtable)
(add_new_expr `vmbin    emit_vmbin)

(var vm-eval-code `(

(int    stack_size) ; in words
(int*   stack)

(fun vm_init (stsize) (
    (= stack (alloc_block stsize))
    (= stack_size stsize)
    ))

(fun vm_eval (insn) (
    (asm "pushl %ebx")
    (asm "pushl %esi")
    (asm "movl stack, %esi")
    (asm "movl stack_size, %eax")
    (asm "addl %eax, %esi")
    (asm "movl 8(%ebp), %ebx")
    (vmfetch)
    (vmtable insn_table @insn_entries)
    (asm "popl %esi")
    (asm "popl %ebx")
    ))
))
